name: "Deploy: Extractors (Cloud Run Jobs)"

# Only NetSuite and Plaid require custom extractors.
# QuickBooks, Stripe, and Salesforce are managed by Fivetran.

on:
  push:
    branches: [main]
    paths:
      - 'extractors/**'
      - 'Dockerfile.extractors'
      - '.github/workflows/deploy-extractors.yml'
  workflow_dispatch:

permissions:
  contents: read
  id-token: write

env:
  GCP_PROJECT_ID: ${{ vars.GCP_PROJECT_ID }}
  GCP_REGION: ${{ vars.GCP_REGION || 'us-east1' }}
  AR_REPO: financial-data-platform
  IMAGE_NAME: extractors

jobs:
  build-and-deploy:
    name: Build & Deploy Custom Extractors
    runs-on: ubuntu-latest
    environment: production

    steps:
      - uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.WIF_PROVIDER }}
          service_account: ${{ secrets.WIF_SERVICE_ACCOUNT }}

      - name: Configure Docker for Artifact Registry
        run: gcloud auth configure-docker ${{ env.GCP_REGION }}-docker.pkg.dev --quiet

      - name: Create Artifact Registry repo (idempotent)
        run: |
          gcloud artifacts repositories describe ${{ env.AR_REPO }} \
            --location=${{ env.GCP_REGION }} 2>/dev/null || \
          gcloud artifacts repositories create ${{ env.AR_REPO }} \
            --repository-format=docker \
            --location=${{ env.GCP_REGION }} \
            --description="Financial data platform images"

      - name: Build and push Docker image
        env:
          IMAGE_TAG: ${{ env.GCP_REGION }}-docker.pkg.dev/${{ env.GCP_PROJECT_ID }}/${{ env.AR_REPO }}/${{ env.IMAGE_NAME }}
        run: |
          docker build -f Dockerfile.extractors -t $IMAGE_TAG:${{ github.sha }} -t $IMAGE_TAG:latest .
          docker push $IMAGE_TAG:${{ github.sha }}
          docker push $IMAGE_TAG:latest

      - name: Deploy NetSuite extractor
        uses: google-github-actions/deploy-cloudrun@v2
        with:
          job: extract-netsuite
          image: ${{ env.GCP_REGION }}-docker.pkg.dev/${{ env.GCP_PROJECT_ID }}/${{ env.AR_REPO }}/${{ env.IMAGE_NAME }}:${{ github.sha }}
          region: ${{ env.GCP_REGION }}
          env_vars: |
            GCP_PROJECT_ID=${{ env.GCP_PROJECT_ID }}
            BQ_DATASET_RAW=raw_netsuite
          secrets: |
            NS_ACCOUNT_ID=NS_ACCOUNT_ID:latest
            NS_CONSUMER_KEY=NS_CONSUMER_KEY:latest
            NS_CONSUMER_SECRET=NS_CONSUMER_SECRET:latest
            NS_TOKEN_ID=NS_TOKEN_ID:latest
            NS_TOKEN_SECRET=NS_TOKEN_SECRET:latest
          flags: >-
            --command=python
            --args=-m,extractors.netsuite.extract
            --cpu=1
            --memory=2Gi
            --max-retries=2
            --task-timeout=3600s
            --service-account=${{ secrets.PIPELINE_SERVICE_ACCOUNT }}

      - name: Deploy Plaid extractor
        uses: google-github-actions/deploy-cloudrun@v2
        with:
          job: extract-plaid
          image: ${{ env.GCP_REGION }}-docker.pkg.dev/${{ env.GCP_PROJECT_ID }}/${{ env.AR_REPO }}/${{ env.IMAGE_NAME }}:${{ github.sha }}
          region: ${{ env.GCP_REGION }}
          env_vars: |
            GCP_PROJECT_ID=${{ env.GCP_PROJECT_ID }}
            BQ_DATASET_RAW=raw_plaid
          secrets: |
            PLAID_CLIENT_ID=PLAID_CLIENT_ID:latest
            PLAID_SECRET=PLAID_SECRET:latest
            PLAID_ACCESS_TOKENS=PLAID_ACCESS_TOKENS:latest
          flags: >-
            --command=python
            --args=-m,extractors.plaid.extract
            --cpu=1
            --memory=1Gi
            --max-retries=2
            --task-timeout=1800s
            --service-account=${{ secrets.PIPELINE_SERVICE_ACCOUNT }}
